diff --git a/run_cast.sh b/run_cast.sh
index e8f6f2d..c3dc465
--- a/run_cast.sh
+++ b/run_cast.sh
@@ -8,18 +8,163 @@ BASEDIR="$(dirname "$0")"
 source <( grep -v '^#' "${BASEDIR}"/settings.conf | grep '=' ) #import settings
 
 receiver_info="RTKBase ${receiver},${version} ${receiver_firmware}"
-in_serial="serial://${com_port}:${com_port_settings}#${receiver_format}"
-in_tcp="tcpcli://localhost:${tcp_port}#${receiver_format}"
+[[ -z "${receiver_inactivity_timeout}" ]] && receiver_inactivity_timeout=60
+in_serial="serial://${com_port}:${com_port_settings}#${receiver_format} -s ${receiver_inactivity_timeout}000 -d 100 -r 1000"
+in_tcp="tcpcli://localhost:${tcp_port}#${receiver_format} -s 0 -d 100 -r 1000"
+in_tcp2="-R 300 -M 2 -H localhost -P ${tcp_port}"
 #in_ext_tcp is mainly for dev purpose to receive a raw stream from another base
 in_ext_tcp="tcpcli://${ext_tcp_source}:${ext_tcp_port}#${receiver_format}"
 
-out_caster_A="-msg ${rtcm_msg_a} -out ntrips://:${svr_pwd_a}@${svr_addr_a}:${svr_port_a}/${mnt_name_a}#rtcm3 -p ${position}"
-#add receiver options if it exists
-[[ ! -z "${ntrip_a_receiver_options}" ]] && out_caster_A=""${out_caster_A}" -opt "${ntrip_a_receiver_options}""
+is_ELT07x5(){
+   [[ -c /dev/gpiochip0 ]] && CHIP=0
+   [[ -c /dev/gpiochip512 ]] && CHIP=512
+   if [[ -n ${CHIP} ]]; then
+      if gpioget -v | grep gpioget | grep -q v1; then
+         gpio4=$(gpioget gpiochip${CHIP} 4)
+      else
+         gpio4=$(gpioget -c gpiochip${CHIP} --numeric 4)
+      fi
+      [[ "${gpio4}" == "0" ]] && return 0
+   fi
+   return 1
+}
 
-out_caster_B="-msg ${rtcm_msg_b} -out ntrips://:${svr_pwd_b}@${svr_addr_b}:${svr_port_b}/${mnt_name_b}#rtcm3 -p ${position}"
-#add receiver options if it exists
-[[ ! -z "${ntrip_b_receiver_options}" ]] && out_caster_B=""${out_caster_B}" -opt "${ntrip_b_receiver_options}""
+PrepareNtripServer(){
+  name=svr_addr_${1}
+  svr_addr=${!name}
+  #echo svr_addr=${svr_addr} svr_addr_a=${svr_addr_a} name=${name} !name=${!name}
+  name=svr_port_${1}
+  svr_port=${!name}
+  name=svr_mode_${1}
+  svr_mode=${!name}
+  name=svr_login_${1}
+  svr_login=${!name}
+  name=svr_pwd_${1}
+  svr_pwd=${!name}
+  name=mnt_name_${1}
+  mnt_name=${!name}
+  name=rtcm_msg_${1}
+  rtcm_msg=${!name}
+  name=ntrip_${1}_receiver_options
+  ntrip_receiver_options=${!name}
+  if [[ "${svr_addr}" == "servers.onocoy.com" ]] && [[ "${svr_mode}" == "0" ]]; then
+     #echo Onocoy NTRIP v1 used!
+     mnt_name=${svr_login}
+     svr_login=
+  fi
+  #echo ${svr_addr}:${svr_port} ${mnt_name}@${svr_login}/${svr_pwd}
+
+  HAVE_PI4=`cat /proc/cpuinfo | grep Model | grep "Pi 4"`
+  HAVE_ZERO=`cat /proc/cpuinfo | grep Model | grep "Pi Zero 2 W"`
+  HAVE_TYPEC=`lsusb | grep "Bus 003" | grep -v "root hub"`
+  HAVE_DEB12=`lsb_release -c | grep bookworm`
+  HAVE_ELT0x33=`find -P /dev/serial/by-id -name "*ELT0x33*" 2>/dev/null`
+  HAVE_MOSAIC=`find -P /dev/serial/by-id -name "*Septentrio*" 2>/dev/null`
+  #echo HAVE_ELT0x33=${HAVE_ELT0x33} HAVE_MOSAIC=${HAVE_MOSAIC}
+  if [[ "${HAVE_ELT0x33}" == "" ]] && [[ "${HAVE_PI4}" != "" ]] && [[ "${HAVE_TYPEC}" != "" ]] && [[ "${HAVE_DEB12}" != "" ]]; then
+     model_type=1
+  elif [[ "${HAVE_ELT0x33}" != "" ]] && [[ "${HAVE_MOSAIC}" == "" ]]; then
+     model_type=3
+  elif [[ "${HAVE_ELT0x33}" == "" ]] && [[ "${HAVE_MOSAIC}" != "" ]] && [[ "${HAVE_ZERO}" != "" ]]; then
+     model_type=3
+  fi
+  device_type=3
+  if [[ "${receiver}" =~ "Unicore" ]]; then
+     receive_type=1
+  elif [[ "${receiver}" =~ "u-blox" ]]; then
+     receive_type=4
+  elif [[ "${receiver}" =~ "Bynav" ]]; then
+     receive_type=6
+  elif [[ "${receiver}" =~ "Septentrio" ]]; then
+     receive_type=7
+     if is_ELT07x5; then
+        model_type=5
+        if [[ "${receiver}" =~ "mosaic-H" ]]; then
+           device_type=1
+        elif [[ "${receiver}" =~ "mosaic-X5" ]]; then
+           device_type=2
+        elif [[ "${receiver}" =~ "mosaic-T" ]]; then
+           device_type=4
+        else
+           device_type=
+        fi
+     fi
+  fi
+  if [[ "${model_type}" != "" ]] && [[ "${device_type}" != "" ]] && [[ "${receive_type}" != "" ]]; then
+     revision="ELT0${receive_type}${device_type}${model_type}"
+  else
+     revision="ELT_RTKBase_DIY"
+  fi
+  #echo revision=${revision} receive_type=${receive_type} device_type=${device_type} model_type=${model_type}
+
+  case "${svr_mode}" in
+    1)
+       out="tcpcli://${svr_addr}:${svr_port}#rtcm3"
+       ;;
+    2)
+       if [[ "${mnt_name}" == TCP ]] && [[ "${svr_pwd}" == TCP ]]; then
+          out_caster="-O 5 -a ${svr_addr} -p ${svr_port} -L ${BASEDIR}/ntrip_${2}.flg"
+       elif [[ -z "${svr_login}"  ]]; then
+          out_caster="-O 3 -a ${svr_addr} -p ${svr_port} -m ${mnt_name} -c ${svr_pwd} -L ${BASEDIR}/ntrip_${2}.flg"
+       elif [[ -z "${mnt_name}"  ]]; then
+          out_caster="-O 3 -a ${svr_addr} -p ${svr_port} -n ${svr_login} -c ${svr_pwd} -L ${BASEDIR}/ntrip_${2}.flg"
+       else
+          out_caster="-O 1 -a ${svr_addr} -p ${svr_port} -m ${mnt_name} -n ${svr_login} -c ${svr_pwd} -L ${BASEDIR}/ntrip_${2}.flg"
+       fi
+       ;;
+    3)
+       out_caster="-O 2 -a ${svr_addr} -p ${svr_port} -m ${mnt_name} -n ${svr_login} -c ${svr_pwd} -L ${BASEDIR}/ntrip_${2}.flg"
+       ;;
+    4)
+       out_caster="-O 4 -a ${svr_addr} -p ${svr_port} -m ${mnt_name} -n ${svr_login} -c ${svr_pwd} -L ${BASEDIR}/ntrip_${2}.flg"
+       ;;
+    *)
+       if [[ "${mnt_name}" == TCP ]] && [[ "${svr_pwd}" == TCP ]]; then
+          out="tcpcli://${svr_addr}:${svr_port}#rtcm3"
+       else
+          out="ntrips://:${svr_pwd}@${svr_addr}:${svr_port}/${mnt_name}#rtcm3"
+       fi
+       ;;
+  esac
+  if [[ -z "${out_caster}" ]]; then
+     out_caster="-msg ${rtcm_msg} -out ${out} -p ${position}"
+  fi
+
+  #add receiver options if it exists
+  if [[ "${svr_mode}" < 2 ]]; then
+     [[ ! -z "${ntrip_receiver_options}" ]] && out_caster=""${out_caster}" -opt "${ntrip_receiver_options}""
+     flags="-t ${level} -fl ${logdir}/str2str_ntrip_${2}.log -fg ${BASEDIR}/ntrip_${2}.flg -fr ${revision}"
+     #echo flags=\"${flags}\"
+  fi
+
+  #echo out_caster_${2}=\"${out_caster}\"
+  #eval out_caster_${2}=\"${out_caster}\"
+}
+
+StartNtripServer(){
+  #echo StartNtripServer $1 $2 $3
+  echo Starting... >${BASEDIR}/ntrip_${3}.flg
+  PrepareNtripServer $2 $3
+  #echo out_caster_${3}=\"${out_caster}\"
+  ntrip_flag="${BASEDIR}/tools/ntrip_led.sh ${3}"
+  if [[ "${svr_mode}" < 2 ]]; then
+     if [[ "$3" == "A" ]]; then
+        #echo ${cast} -in ${!1} ${out_caster} -i \"${receiver_info}\" -a \"${antenna_info}\" ${flags}  -fe \"${ntrip_flag}\" \&
+        ${cast} -in ${!1} ${out_caster} -i "${receiver_info}" -a "${antenna_info}" ${flags} -fe "${ntrip_flag}" &
+     else
+        #echo ${cast} -in ${!1} ${out_caster} -i \"${receiver_info}\" -a \"${antenna_info}\" ${flags} \&
+        ${cast} -in ${!1} ${out_caster} -i "${receiver_info}" -a "${antenna_info}" ${flags} &
+     fi
+  else
+     if [[ "$3" == "A" ]]; then
+        #echo ${cast2} ${in_tcp2} ${out_caster} -S ${revision} -Q \"${ntrip_flag}\" \&
+        ${cast2} ${in_tcp2} ${out_caster} -S ${revision} -Q "${ntrip_flag}" &
+     else
+        #echo ${cast2} ${in_tcp2} ${out_caster} -S ${revision} \&
+        ${cast2} ${in_tcp2} ${out_caster} -S ${revision} &
+     fi
+  fi
+}
 
 array_pos=(${position})
 if [[ ${local_ntripc_user} == '' ]] && [[ ${local_ntripc_pwd} == '' ]]
@@ -28,72 +173,114 @@ if [[ ${local_ntripc_user} == '' ]] && [[ ${local_ntripc_pwd} == '' ]]
   else
     local_ntripc_auth='B' #Basic authentification
 fi
-out_local_caster_source_table="${local_ntripc_mnt_name};rtcm3;${local_ntripc_msg};${receiver_frequency_count};GPS+GLO+GAL+BDS+QZS;NONE;NONE;${array_pos[0]};${array_pos[1]};0;0;RTKBase_${receiver},${version};NONE;${local_ntripc_auth};N;;"
-out_local_caster="-msg ${local_ntripc_msg} -out ntripc://${local_ntripc_user}:${local_ntripc_pwd}@:${local_ntripc_port}/${local_ntripc_mnt_name}:${out_local_caster_source_table}#rtcm3 -p ${position}"
+out_local_caster_source_table="${local_ntripc_mnt_name};rtcm3;${local_ntripc_msg};${receiver_frequency_count};GPS+GLO+GAL+BDS+QZS+SBAS+IRN;NONE;NONE;${array_pos[0]};${array_pos[1]};0;0;RTKBase_${receiver},${version};NONE;${local_ntripc_auth};N;;"
+out_local_caster_out="ntripc://${local_ntripc_user}:${local_ntripc_pwd}@:${local_ntripc_port}/${local_ntripc_mnt_name}:${out_local_caster_source_table}#rtcm3"
+out_local_caster="-msg ${local_ntripc_msg} -out ${out_local_caster_out} -p ${position}"
 #add receiver options if it exists
 [[ ! -z "${local_ntripc_receiver_options}" ]] && out_local_caster="${out_local_caster} -opt ${local_ntripc_receiver_options}"
+[[ "${receiver_format}" == "rtcm3" ]] && [[ "${receiver}" =~ u-blox ]] && out_tcp_msg="-msg 1019,1020,1041,1042,1044,1045,1046"
+[[ "${receiver_format}" == "rtcm3" ]] && [[ "${receiver}" =~ u-blox ]] && out_tcp_format="#rtcm3 -ub"
+out_tcp="${out_tcp_msg} -out tcpsvr://${tcp_host_addr}:${tcp_port}${out_tcp_format}"
 
-out_tcp="tcpsvr://${tcp_host_addr}:${tcp_port}"
-
-out_file="file://${datadir}/${file_name}.${receiver_format}::T::S=${file_rotate_time} -f ${file_overlap_time}"
+out_file_out="file://${datadir}/${file_name}.${receiver_format}::T::S=${file_rotate_time}"
+out_file="-out ${out_file_out} -f ${file_overlap_time}"
 
-out_rtcm_svr="-msg ${rtcm_svr_msg} -out tcpsvr://:${rtcm_svr_port}#rtcm3 -p ${position}"
+[[ "${receiver_format}" != "rtcm3" ]] && rtcm_out_format="#rtcm3"
+[[ "${receiver_format}" == "ubx" ]] && rtcm_out_ub="-ub"
+out_rtcm_svr_out="tcpsvr://:${rtcm_svr_port}${rtcm_out_format}"
+out_rtcm_svr="-msg ${rtcm_svr_msg} -out ${out_rtcm_svr_out} ${rtcm_out_ub} -b 1 -p ${position}"
 #add receiver options if it exists
 [[ ! -z "${rtcm_receiver_options}" ]] && out_rtcm_svr=""${out_rtcm_svr}" -opt "${rtcm_receiver_options}""
 
-out_rtcm_client="-msg ${rtcm_client_msg} -out tcpcli://${rtcm_client_user}:${rtcm_client_pwd}@${rtcm_client_addr}:${rtcm_client_port}#rtcm3 -p ${position}"
+out_rtcm_client_out="tcpcli://${rtcm_client_user}:${rtcm_client_pwd}@${rtcm_client_addr}:${rtcm_client_port}#rtcm3"
+out_rtcm_client="-msg ${rtcm_client_msg} -out ${out_rtcm_client_out} -p ${position}"
 #add receiver options if it exists
 [[ ! -z "${rtcm_client_receiver_options}" ]] && out_rtcm_client=""${out_rtcm_client}" -opt "${rtcm_receiver_client_options}""
 
-out_rtcm_udp_svr="-msg ${rtcm_udp_svr_msg} -out udpsvr://:${rtcm_udp_svr_port}#rtcm3 -p ${position}"
+out_rtcm_udp_svr_out="udpsvr://:${rtcm_udp_svr_port}#rtcm3"
+out_rtcm_udp_svr="-msg ${rtcm_udp_svr_msg} -out ${out_rtcm_udp_svr_out} -p ${position}"
 #add receiver options if it exists
 [[ ! -z "${rtcm_udp_svr_receiver_options}" ]] && out_rtcm_udp_svr=""${out_rtcm_udp_svr}" -opt "${rtcm_udp_svr_receiver_options}""
 
-out_rtcm_serial="-msg ${rtcm_serial_msg} -out serial://${out_com_port}:${out_com_port_settings}#rtcm3 -p ${position}"
+out_rtcm_serial_out="serial://${out_com_port}:${out_com_port_settings}#rtcm3"
+out_rtcm_serial="-msg ${rtcm_serial_msg} -out ${out_rtcm_serial_out} -p ${position}"
 #add receiver options if it exists
 [[ ! -z "${rtcm_serial_receiver_options}" ]] && out_rtcm_serial=""${out_rtcm_serial}" -opt "${rtcm_serial_receiver_options}""
 
-mkdir -p ${logdir}
+[[ -n "${logdir}" ]] && mkdir -p ${logdir}
+
+if [[ "${antenna_info}" == "ELT0123" ]] || [[ "${antenna_info}" == "ELT0323" ]]; then
+   antenna_info="HXCSX627A"
+fi
 
   case "$2" in
     out_tcp)
-    #echo ${cast} -in ${!1} -out $out_tcp
+    #echo receiver="${receiver}" position="${position}"
+    #echo ${BASEDIR}/UnicoreSetBasePos.sh "${com_port}" "${com_port_settings%%:*}" "${position}" "${receiver}" "${antenna_info}" "${receiver_format}"
+    ${BASEDIR}/UnicoreSetBasePos.sh "${com_port}" "${com_port_settings%%:*}" "${position}" "${receiver}" "${antenna_info}" "${receiver_format}"
+    #${BASEDIR}/UnicoreSetBasePos.sh "${com_port}" "${com_port_settings%%:*}" "${position}" "${receiver}" "${antenna_info}">>${BASEDIR}/debug.log 2>&1
+    exitcode=$?
+    #echo UnicoreSetBasePos exitcode=${exitcode} >>${BASEDIR}/debug.log 2>&1
+    #echo ============================================== >>${BASEDIR}/debug.log 2>&1
+    if [[ ${exitcode} != 0 ]]; then
+       echo run_cast exit with exitcode ${exitcode}
+       exit ${exitcode}
+    fi
+    RAW2NMEA_SERVICE=rtkbase_raw2nmea.service
+    enabled=$(systemctl is-enabled ${RAW2NMEA_SERVICE})
+    if [[ "${enabled}" == "enabled" ]]; then
+       active=$(systemctl is-active ${RAW2NMEA_SERVICE})
+       #echo enabled=${enabled} active=${active}
+       [[ "${active}" != "active" ]] && systemctl start ${RAW2NMEA_SERVICE}
+    fi
     # What is this ${!1} ? It's variable indirection
-    ${cast} -in ${!1} -out ${out_tcp} -b 1 -t ${level} -fl ${logdir}/str2str_tcp_$(date "+%F-%T").log
+    #echo ${cast} -in ${!1} ${out_tcp} -b 1  -t ${level} ${logdir}/str2str_tcp_$(date "+%F-%T").log \&
+    ${cast} -in ${!1} ${out_tcp} -b 1 -t ${level} ${logdir}/str2str_tcp_$(date "+%F-%T").log &
     ;;
 
   out_caster_A)
-    #echo ${cast} -in ${!1} -out $out_caster
-    ${cast} -in ${!1} ${out_caster_A} -i "${receiver_info}" -a "${antenna_info}" -t ${level} -fl ${logdir}/str2str_ntrip_A.log
+    StartNtripServer ${1} a A
     ;;
 
   out_caster_B)
-    ${cast} -in ${!1} ${out_caster_B} -i "${receiver_info}" -a "${antenna_info}" -t ${level} -fl ${logdir}/str2str_ntrip_B.log
+    StartNtripServer ${1} b B
+    ;;
+
+  out_caster_C)
+    StartNtripServer ${1} c C
+    ;;
+
+  out_caster_D)
+    StartNtripServer ${1} d D
+    ;;
+
+  out_caster_E)
+    StartNtripServer ${1} e E
     ;;
 
   out_local_caster)
     #echo ${cast} -in ${!1} -out "${out_local_caster}"
-    ${cast} -in ${!1} ${out_local_caster} -i "${receiver_info}" -a "${antenna_info}" -t ${level} -fl ${logdir}/str2str_ntrip.log
+    ${cast} -in ${!1} ${out_local_caster} -i "${receiver_info}" -a "${antenna_info}" -t ${level} -fl ${logdir}/str2str_ntrip.log &
     ;;
 
   out_rtcm_svr)
     #echo ${cast} -in ${!1} -out $out_rtcm_svr
-    ${cast} -in ${!1} ${out_rtcm_svr} -i "${receiver_info}" -a "${antenna_info}" -t ${level} -fl ${logdir}/str2str_rtcm_svr.log
+    ${cast} -in ${!1} ${out_rtcm_svr} -i "${receiver_info}" -a "${antenna_info}" -t ${level} -fl ${logdir}/str2str_rtcm_svr.log &
     ;;
   
   out_rtcm_client)
     #echo ${cast} -in ${!1} -out $out_rtcm_client
-    ${cast} -in ${!1} ${out_rtcm_client} -i "${receiver_info}" -a "${antenna_info}" -t ${level} -fl ${logdir}/str2str_rtcm_client.log
+    ${cast} -in ${!1} ${out_rtcm_client} -i "${receiver_info}" -a "${antenna_info}" -t ${level} -fl ${logdir}/str2str_rtcm_client.log &
   ;;
 
   out_rtcm_udp_svr)
     #echo ${cast} -in ${!1} -out $out_rtcm_udp_svr
-    ${cast} -in ${!1} ${out_rtcm_udp_svr} -i "${receiver_info}" -a "${antenna_info}" -t ${level} -fl ${logdir}/str2str_rtcm_udp_svr.log
+    ${cast} -in ${!1} ${out_rtcm_udp_svr} -i "${receiver_info}" -a "${antenna_info}" -t ${level} -fl ${logdir}/str2str_rtcm_udp_svr.log &
     ;;
   
   out_rtcm_serial)
     #echo ${cast} -in ${!1} -out $out_rtcm_serial
-    ${cast} -in ${!1} ${out_rtcm_serial} -i "${receiver_info}" -a "${antenna_info}" -t ${level} -fl ${logdir}/str2str_rtcm_serial.log
+    ${cast} -in ${!1} ${out_rtcm_serial} -i "${receiver_info}" -a "${antenna_info}" -t ${level} -fl ${logdir}/str2str_rtcm_serial.log &
     ;;
 
   out_file)
@@ -103,8 +290,12 @@ mkdir -p ${logdir}
     if [ ${ret} -eq 0 ]
     then
       mkdir -p ${datadir}
-      ${cast} -in ${!1} -out ${out_file} -t ${level} -fl ${logdir}/str2str_file.log
+      ${cast} -in ${!1} ${out_file} -t ${level} -fl ${logdir}/str2str_file.log &
     fi
     ;;
-    
+
+  *)
+    echo Service "$2" unknown
+    ;;
+
   esac
